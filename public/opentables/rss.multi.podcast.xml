<?xml version="1.0"?>
<table xmlns="http://query.yahooapis.com/v1/schema/table.xsd">
  <meta>
    <author>Christian Heilmann</author>
    <description>Weather with woeid</description>
    <documentationURL>http://developer.yahoo.com/weather/</documentationURL>
  </meta>
  <bindings>
    <select produces="XML" itemPath="">
      <inputs>
        <key id="feeds" type="xs:string" paramType="variable" required="true"/>
        <key id="html" type="xs:string" paramType="variable" required="false"/>
        <key id="compact" type="xs:string" paramType="variable" required="false"/>
      </inputs>
        <execute><![CDATA[
          var feedlist = feeds.split(',');
          if(!html){
          var out = <feeds/>;
          for(var i=0,j=feedlist.length;i<j;i++){
            var f = feedlist[i];
            var q = 'select channel.title,channel.link,channel.item.title,channel.item.link';
            if(!compact){
              q+=',channel.item.description';
            }
            q += ' from xml where url='+f;
            y.log(q);
            var content = y.query(q);
            y.log(content.results.rss);
            feed = <feed/>;
            feed.title = content.results.rss[0].channel.title;
            feed.link = content.results.rss[0].channel.link;
            for each(rss in content.results.rss){
				// create query for scrape
				var scrape = 'select \* from html where url="' + rss.channel.item.link.text() + '" ' + 'and xpath="//\*[\@id\=\'ff2\']//td[2]/a"';

				y.log(scrape);
				// get scrape results
				var scrape_content = y.query(scrape);
				// y.log(scrape_content.results.a);
				
				item = <item/>;
				item.anchor = "a";
				item.title = rss.channel.item.title;
				item.link  = rss.channel.item.link;
				item.enclosure.@type = 'audio/mpeg';
				item.enclosure.@length = "1111";
				item.enclosure.@url = 'http://www.archive.org' + scrape_content.results.a.@href;
				out.item += item;
            }
            out.feed += feed;
          }
          
          } else {
          var out = <div class="feeds"/>;
          for(var i=0,j=feedlist.length;i<j;i++){
            var f = feedlist[i];
            var q = 'select channel.title,channel.link,channel.item.title,channel.item.link';
            if(!compact){
              q+=',channel.item.description';
            }
            q += ' from xml where url='+f;
            var content = y.query(q);
            feed = <div class="feed"/>;
            feed.h2 = <h2/>;
            feed.h2.a = <a/>;
            feed.h2.a.@href = content.results.rss[0].channel.link.text();
            feed.h2.a.content = content.results.rss[0].channel.title.text();
            feed.ul = <ul/>;
            for each(rss in content.results.rss){
              var li = <li/>;
              li.a = <a/>;
              li.a.@href = rss.channel.item.link.text();
              li.a.content = rss.channel.item.title.text();
              li.p = <p>{rss.channel.item.description.text()}</p>;
              feed.ul.li += li;
            }
            out.feed += feed;
          }
          
          }
          response.object = out;
        ]]></execute>
    </select>
  </bindings>
</table>